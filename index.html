<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<% if (env.VITE_GTM_ID) { %>
		<!-- Google Tag Manager -->
		<script>
			(function (w, d, s, l, i) {
				w[l] = w[l] || [];
				w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
				var f = d.getElementsByTagName(s)[0],
					j = d.createElement(s),
					dl = l != "dataLayer" ? "&l=" + l : "";
				j.async = true;
				j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
				f.parentNode.insertBefore(j, f);
			})(window, document, "script", "dataLayer", "<%= env.VITE_GTM_ID %>");
		</script>
		<!-- End Google Tag Manager -->
		<% } %>

		<link rel="icon" type="image/svg+xml" href="/favicon.png" />
		<title>AutoKitteh</title>

		<% if (env.VITE_MS_CLARITY_ID) { %>
		<!-- Start of Clarity -->
		 <script type="text/javascript">
			(function(c,l,a,r,i,t,y){
				c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
				t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
				y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
			})(window, document, "clarity", "script", "<%= env.VITE_MS_CLARITY_ID %>");
			
			// Configure Clarity for SPA - disable auto page tracking
			window.clarity("set", "auto_capture", false);
		</script>
		<!-- End of Clarity -->
		<% } %>

		<% if (env.VITE_DATADOG_APPLICATION_ID && env.VITE_DATADOG_CLIENT_TOKEN) { %>
		<!-- Datadog RUM -->
		<script>
			(function(h,o,u,n,d) {
				h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
				d=o.createElement(u);d.async=1;d.src=n
				n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
			})(window,document,'script','https://www.datadoghq-browser-agent.com/us1/v6/datadog-rum.js','DD_RUM')
			
			// Initialize Datadog RUM immediately
			window.DD_RUM.onReady(function() {
				console.log('[Datadog] ðŸš€ Initializing RUM from HTML');
				
				// Check for E2E test environment
				const urlParams = new URLSearchParams(window.location.search);
				const hasE2eParam = urlParams.get('e2e') === 'true';
				const userAgent = navigator.userAgent.toLowerCase();
				const hasHeadless = userAgent.includes('headless');
				const isE2eTest = hasE2eParam || hasHeadless;
				
				if (isE2eTest) {
					console.warn('[Datadog] â›” E2E test detected - skipping initialization');
					return;
				}
				
				// Initialize with configuration
				window.DD_RUM.init({
					applicationId: '<%= env.VITE_DATADOG_APPLICATION_ID %>',
					clientToken: '<%= env.VITE_DATADOG_CLIENT_TOKEN %>',
					site: '<%= env.VITE_DATADOG_SITE || "datadoghq.com" %>',
					service: '<%= env.VITE_DATADOG_SERVICE || "autokitteh-web" %>',
					env: '<%= env.VITE_DATADOG_ENV || "development" %>',
					version: '<%= env.VITE_DATADOG_VERSION || "1.0.0" %>',
					sessionSampleRate: 100,
					sessionReplaySampleRate: 100,
					defaultPrivacyLevel: 'mask-user-input',
					beforeSend: function(event, context) {
						console.log('[Datadog beforeSend] Event received:', {
							type: event.type,
							view: event.view,
							action: event.action,
							error: event.error
						});
						
						// Double-check E2E filtering
						const currentUrlParams = new URLSearchParams(window.location.search);
						const currentHasE2eParam = currentUrlParams.get('e2e') === 'true';
						const currentUserAgent = navigator.userAgent.toLowerCase();
						const currentHasHeadless = currentUserAgent.includes('headless');
						const currentIsE2eTest = currentHasE2eParam || currentHasHeadless;
						
						if (currentIsE2eTest) {
							console.warn('[Datadog beforeSend] â›” Filtering out E2E test event');
							return false;
						}
						
						console.log('[Datadog beforeSend] âœ… Event allowed');
						return true;
					}
				});
				
				console.log('[Datadog] ðŸš€ RUM initialized successfully');
			});
		</script>
		<!-- End Datadog RUM -->
		<% } %>
	</head>
	<body>
		<% if (env.VITE_GTM_ID) { %>
		<!-- Google Tag Manager (noscript) -->
		<noscript
			><iframe
				src="https://www.googletagmanager.com/ns.html?id=%VITE_GTM_ID%"
				height="0"
				width="0"
				style="display: none; visibility: hidden"
			></iframe
		></noscript>
		<!-- End Google Tag Manager (noscript) -->
		<% } %>
		<div id="root"></div>
		<script type="module" src="/src/main.tsx"></script>
		<% if (env.VITE_HUBSPOT_PORTAL_ID) { %>
		<!-- Start of HubSpot Embed Code -->
		<script type="module">
			import { initHubSpot } from '/src/utils/initHubSpot.ts';
			initHubSpot('<%= env.VITE_HUBSPOT_PORTAL_ID %>');
		</script>
		<!-- End of HubSpot Embed Code -->
		<% } %>
	</body>
</html>
