#!/bin/sh

# Check if there are any staged files
all_staged_files=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$all_staged_files" ]; then
    echo "‚ÑπÔ∏è  No staged files found."
    exit 0
fi

if [ "$process.env.VITE_RUN_VISUAL_REGRESSION_TESTS" === "true" ]; then
# ===========================================
# Connection Test Data Check
# ===========================================
CONNECTIONS_FILE="e2e/fixtures/connectionsTestCases.json"

echo "üîÑ Running generate:connection-test-data..."
npm run generate:connection-test-data

# Check if connectionsTestCases.json has unstaged changes
if git diff --name-only | grep -q "^${CONNECTIONS_FILE}$"; then
    echo ""
    echo "‚ùå ERROR: ${CONNECTIONS_FILE} has changed after running generate:connection-test-data!"
    echo "   The connections data is out of sync."
    echo ""
    echo "   Please stage the file and commit again:"
    echo "   git add ${CONNECTIONS_FILE}"
    echo ""
    exit 1
fi
fi

# ===========================================
# Lint-staged Check
# ===========================================

# Run lint-staged and check if it fails
if ! npx lint-staged; then
    echo "‚ö†Ô∏è  lint-staged failed, running lint --fix on staged files..."

    # Get staged files that match our lint patterns
    staged_files=$(echo "$all_staged_files" | grep -E '\.(ts|tsx|js)$')

    if [ -n "$staged_files" ]; then
        # Run lint --fix on staged files
        if npx eslint --fix $staged_files; then
            # Add the fixed files back to staging
            git add $staged_files

            echo "‚úÖ Linting issues fixed and files re-staged. Commit will proceed."
            # Exit successfully to allow the commit to proceed
            exit 0
        else
            echo "‚ùå Failed to fix linting issues."
            exit 1
        fi
    else
        echo "‚úÖ No TypeScript/JavaScript files to lint. Allowing commit to proceed."
        exit 0
    fi
fi
