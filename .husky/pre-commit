#!/bin/sh

# Run lint-staged and check if it fails
if ! npx lint-staged; then
    echo "⚠️  lint-staged failed, running lint --fix on staged files..."
    
    # Get staged files that match our lint patterns
    staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js)$')
    
    if [ -n "$staged_files" ]; then
        # Run lint --fix on staged files
        if npx eslint --fix $staged_files; then
            # Add the fixed files back to staging
            git add $staged_files
            
            echo "✅ Linting issues fixed and files re-staged. Commit will proceed."
            # Exit successfully to allow the commit to proceed
            exit 0
        else
            echo "❌ Failed to fix linting issues."
            exit 1
        fi
    else
        echo "❌ No staged files to fix."
        exit 1
    fi
fi
