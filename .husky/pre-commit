#!/bin/sh

# Remove console.log from staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js)$')

if [ -n "$staged_files" ]; then
    echo "üßπ Checking for console.log violations flagged by ESLint..."
    node scripts/removeConsoleLogs.js $staged_files

    # Re-stage the modified files if any were changed
    git add $staged_files 2>/dev/null || true
fi

# Run lint-staged and check if it fails
if ! npx lint-staged; then
    echo "‚ö†Ô∏è  lint-staged failed, running lint --fix on staged files..."
    
    # Get staged files that match our lint patterns
    staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js)$')
    
    if [ -n "$staged_files" ]; then
        # Run lint --fix on staged files
        if npx eslint --fix $staged_files; then
            # Add the fixed files back to staging
            git add $staged_files
            
            echo "‚úÖ Linting issues fixed and files re-staged. Commit will proceed."
            # Exit successfully to allow the commit to proceed
            exit 0
        else
            echo "‚ùå Failed to fix linting issues."
            exit 1
        fi
    else
        echo "‚ùå No staged files to fix."
        exit 1
    fi
fi
